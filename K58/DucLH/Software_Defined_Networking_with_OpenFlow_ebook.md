# Software Defined Networking with OpenFlow

## Chương 1: Introducing OpenFlow

Để hiểu được vai trò của OpenFlow, cách xây dựng các thành phần của OpenFlow và cách nó được sử dụng để phát triển các application mạng dựa trên OpenFlow (OpenFlow-based network application), thì chúng ta cần được cung cấp một kiến thức cơ bản về OpenFlow và cách nó làm việc. Chương này cung cấp các kiến thức cần thiết về OpenFlow trước khi cài đặt thực tế các môi trường hỗ trợ SDN/OpenFlow. OpenFlow được xem như là implementation đầy tiên của SDN. Vì vậy, trước khi đi vào OpenFlow, chúng ta sẽ tìm hiểu những kiến thức cơ bản về SDN và cách nó hoạt động.

### 1.1 Những hiểu biết về Software Defined Networking - OpenFlow

Software Defined Networking (SDN) là một tư tưởng mới có tính cách mạng trong computer networking, kiến trúc này hỗ trợ việc điều khiển, quản lý network một cách dễ dàng, tự động và cho phép phát triển các ý tưởng mới thông qua khả năng có thể lập trình network. Computer networking về cơ bản được xây dựng từ một số lượng lớn các thiết bị mạng (network device) ví dụ như switch, router, firewall,... kết hợp với rất nhiều protocol(các protocol này có thể được implement và được gán trên các thiết bị mạng này). Các kỹ sư mạng có trách nhiệm trong việc cấu hình các chính sách để đáp trả lại một tập hợp các sự kiện mạng (network event) và các kịch bản sử dụng của các ứng dụng (application scenarios). Cụ thể, họ chuyển đổi một cách thủ công các chính sách high-level vào trong các câu lệnh configuration ở tầng dưới. Những nhiệm vụ rất phức tạp này thường xuyên được hoàn thành với khả năng rất dưới hạn của các công cụ hỗ trợ. Vì vậy, tối ưu hóa hiệu năng và điều khiển quản lý mạng đang là một thách thức cho nhu cầu mạng ngày nay.

Một thách thức khác là việc các kỹ sư mạng và các nhà nghiên cứu tham chiếu đến như là **Internet ossification**. Do cơ sở triển khai quá lớn và ảnh hưởng của nó đến các khía cạnh của cuộc sống, Internet trở nên vô cùng khó khăn để giải quyết cả về cơ sở hạ tầng vật lý, cùng với các giao thức và hiệu năng mạng. Khi các yêu cầu về một ứng dụng trở nên phức tạp hơn, thì trạng thái internet hiện tại dường như không có thể phát triển để giải quyết các thách thức hiện nay.

Và khái niệm **programmable network** đã được đề xuất như là một cách để tạo ra sự thuận tiện trong việc phát triển network. Cụ thể, SDN là một mô hình mạng mới, mà trong đó, các phần cứng dùng để forwarding(vd: các dụng cụ chuyển tiếp gói tin chuyên dụng) được tách biệt với phần điều khiển quyết định (các giao thức hay là các phần mềm điều khiển). Việc di chuyển phần control, mà trước đây được tích hợp chặt chẽ trong các thiết bị mạng (vd: Ethernet switch) vào các controller được tập trung hóa và có khả năng truy cập, cho phép cơ sở hạ tầng mạng bên dưới có thể được trừu tượng hóa từ tầm nhìn của các ứng dụng. Việc tách biệt này sẽ tạo ra một kiến trúc mạng có tính mềm dẻo, có khả năng lập trình, chi phí thấp và có khả năng đổi mới dễ dàng. bên cạnh việc trừu tượng hóa network, kiến trúc SDN sẽ cung cấp một tập các API nhằm tạo đơn giản hóa việc triển khai các dịch vụ mạng thông thường (ví dụ như routing, multicast, security, access control, bandwith management, traffic engineering, QoS,... ). Trong SDN, sự thông minh của network là việc trung tập hóa thành phần controller trong các phần mềm (gọi là control plane), và các thiết bị mạng trở thành các thiết bị forwarding gói tin cơ bản (gọi là data plane) mà có thể được lập trình thông qua một giao diện mở (open interface). Một implementation sớm nhất của open interface  là OpenFlow.

Việc tách biệt phần cứng forwarding với control cho phép dễ dàng triển khai các giao thức và các ứng dụng mới, dễ dàng trong việc quản lý. Thay vì thực thi các chính sách hay các giao thức trên một tập các thiết bị đơn lẻ, mô hình mạng này sẽ được giảm đến mức cơ bản các thiết bị phần cứng forwarding và controller để điều khiển mạng. các thiết bị phần cứng forwarding bao gồm 2 chức năng sau:
- Một flow table chứa các entry flow. Mỗi entry chứa các rule và các action để thực hiện các hành động của flow.
- Một giao thức tầng transport để đảm bảo giao tiếp với một controller về các entry mới sẽ được tạo ra trong flow table.

### Building blocks
SDN switch (ví dụ: OpenFlow Switch), SDN controller, và interface trên controller để biểu diễn giao tiếp với các thiết bị forwarding, southbound interface(OpenFlow), và network application interface(nouthbound interface) là tất cả các thành phần cơ bản cần xây dựng để triển khai mô hình SDN. Các switch trong SDN được xem là các forwarding hardware cơ bản, có khả năng truy cập thông qua open interface, và được điều khiển bởi controller. OpenFlow switch có 2 trạng thái: pure (OpenFLow-only) và hybrid (OpenFlow-enabled).

Pure OpenFlow switch không có các tính năng cũ, có nghĩa là chỉ hỗ trợ duy nhất OpenFlow và hoàn toàn dựa vào một controller cho việc ra quyết định forwarding. Hybrid switch hỗ trợ OpenFlow như một tính năng thêm vào trong tập các giao thức và hoạt động đã có trước đó. Hầu hết các switch thương mại ngày nay là hybrid. Một OpenFlow switch chứa một flow table, thực hiện tra cứu và chuyển tiếp gói tin. Mỗi flow table trong switch sẽ chứa một tập các flow entry chứa các thành phần sau:
- Trường header hay trường match, với các thông tin được tìm thấy trong header của packet, port vào, và metadata, được sử dụng để so khớp các gói dữ liệu gửi đến.
- Counter, được sử dụng để tập hợp thông số cho flow cụ thể, chẳng hạn như số lượng các packet đến, kích thước và thời gian của luồng.
- Tập các action sẽ được thực hiện sau khi tìm thấy luồng, các hành động này thể hiện các xử lý các gói tin phù hợp. Ví dụ, hành động forward gói tin ra một port xác định nào đó.

Hệ thống được tách biệt trong SDN có thể được so sánh với một chương trình ứng dụng và một hệ điều hành trong một nền tảng tính toán. Tức là, trong SDN, controller (là network operating system) cung cấp một interface có khả năng lập trình tạo ra các ứng dụng. Tại đây, các ứng dụng có thể được viết để thực hiện việc điều khiển và quản lý, và cung cấp các tính năng mới. Sơ đồ phân tầng của mô hình SDN được thể hiện trong hình dưới. Sơ đồ này giả sử rằng thành phần control được tập trung tại một nơi và các ứng dụng được viết khi nếu network là một hệ thống duy nhất. Trong khi điều này làm đơn giản hóa việc thực thi các chính sách và nhiệm vụ quản lý, thì một yêu cầu đặt ra là các ràng buộc cần phải được duy trì chặt chẽ giữa controller và các thành phần thực hiện forwarding. Như đã thể hiện trong hình dưới, controller sẽ phải cố gắng để hoạt động như một hệ điều hành mạng và phải implement tối thiểu hai interface: **southbound interface** (vd: OpenFLow) cho phép các switch giao tiếp với controller và **nouthbound interface** để cung cấp các API đến các application/service thực hiện điều khiển và quản lý mạng. Trường header (hay trường match) như thể hiện ở hình dưới. Mỗi entry của flow table chứa một giá trị xác định, hoặc ANY (* hay wildcard, như miêu tả ở hình dưới,) có thể khớp với bất kỳ giá trị nào.

![](https://github.com/huynhducbk95/networking_document/blob/master/image/openflow.png)

Nếu switch hỗ trợ subnet mask trên IP source hoặc các trường destination, thì có thể xác định chính xác hơn các kết quả phù hợp. Trường port (hoặc ingress port) đại diện cho port đi vào switch(tức là port mà các packet đã qua để vào switch) và bắt đầu được đánh số từ 1. Độ dài của trường này là tùy vào từng implement cụ thể. Trường ingress port này được áp dụng cho tất cả các gói tin. Địa chỉ source MAC và destination MAC được áp dụng cho tất cả các gói tin, trên tất cả các port được cho phép của switch và có độ dài là 48 bits. Trường Ethernet type có 16 bits và được áp dụng trên tất cả các gói tin trên các port được cho phép. Một OpenFlow switch phải trùng type với cả chuẩn Ethernet và IEEE 802.2 với một **Subnetwork Access Protocol(SNAP)** header và **Organizationally Unique Identifier (OUI)** của 0x000000. Giá trị đặc biệt 0x05FF được sử dụng để tìm các gói tin 802.2 mà không cần SNAP header. VLAN ID áp dụng trên tất cả các gói tin và Ethernet type là 0x8100. Kích thước của trường này là 12 bits. VLAN priority có 3 bits và được áp dụng cho tất cả packet của Ethernet 0x8100. Trường IP source và IP destination là các thực thể 32 bits và được áp dụng trên tất cả các gói tin IP và gói tin ARP. Các trường này có thể được ẩn đi sử dụng subnet mask. Trường IP protocol được áp dụng đến tất cả các gói tin IP, IP qua Ethernet và gói tin ARP. Độ dài của nó là 8 bit và trong trường hợp gói tin ARP, chỉ 8 bits thấp được sử dụng. IP ToS (Type of Service) bits có độ dài là 6 bits và được áp dụng trên tất cả các gói tin IP. Nó xác định một giá trị 8 bits và đặt ToS trong 6 bit đầu tiên. Trường source và destination transport port address (hoặc ICMP type/code) có độ dài 16 bits và được áp dụng trên các gói tin TCP, UDP và ICMP. Trong trường hợp gói tin ICMP type/code, chỉ có 8bits thấp được xem xét cho việc tìm kiếm.

Counter được duy trì cho mỗi bảng, mỗi flow, mỗi port và mỗi queue. Được sử dụng để thông kê trạng thái hiện tại của flow table, của mỗi flow entry, mỗi port.

Bên cạnh đó, mỗi Flow entry được liên kết với không hoặc nhiều action để chỉ dẫn OpenFlow switch cách xử lý các gói tin phù hợp. Nếu không có hành động forward được thể hiện, gói tin sẽ bị xóa. Danh sách các action phải được xử lý trong một thứ tự xác định. Tuy nhiên, không có một yêu cầu đầu ra nào của một gói tin đảm bảo rằng thực hiện trong một port riêng biệt. Cho ví dụ, hai gói tin được tạo ra và được chỉ định đến cùng một output port như trong xử lý của một action, khi đó, có thể tùy ý sắp xếp lại. Pure OpenFlow switch chỉ hỗ trợ các **required action**, trong khi hybrid OpenFlow switch cũng có thể hỗ trợ **Nomal action**. Mỗi loại switch cũng có thể hỗ trợ **Flood action**. Chúng ta sẽ tìm hiểu về các loại action này.

Đầu tiên, **required action** là:
- **Forward**: OpenFlow switch bắt buộc phải hỗ trợ forwarding các packet đến các port vật lý và những tùy chọn sau:
  - **ALL**: Gửi gói tin đến tất cả các port, bao gồm cả port mà gói tin đó đi vào.
  - **CONTROLLER**: Đóng gói và gửi gói tin đến controller.
  - **LOCAL**: Gửi gói tin đến mạng cục bộ của switch.
  - **TABLE**(chỉ đối với ): thực hiện hành động trong flow table.
  - **IN_PORT**: Gửi packet ra input port.

- **Drop**: Hành động này cho biết tất cả các gói tin phù hợp sẽ bị xóa đi. Một flow entry không có action nào được xác định thì được xem như chứa Drop action.
- **Optional action** bao gồm:
  - **Forward**: Một switch có thể tùy chọn hỗ trợ virtual port sau: *NORMAL* -  Xử lý các gói tin sử dụng path forwarding truyền thống được hỗ trợ bởi switch (đó là các xử lý L2,VLAN,L3,...); *FLOOD* - Flood the packet along the minimum spanning tree, not including the incoming interface.
- **Enqueue**: Hành động này forward gói tin thông qua một hàng đợi được gán đến một port. Hành động forwarding được quyết định bởi việc cấu hình của hàng đợi và được sử dụng để cung cấp việc hỗ trợ QoS cơ bản.

Khi một gói tin đến OpenFlow switch, trường header của packet sẽ được lấy ra và kết hợp với các phần của các trường trong các entry flow của flow table. Việc tìm kiếm flow entry sẽ bắt đầu tại flow entry đầu tiên trong bảng flow và tiếp tục với flow entry tiếp theo sau. Nếu một flow entry được tìm thấy, switch sẽ áp dụng tập các action được liên kết với flow entry đã tìm thấy. Đối với mỗi packet phù hợp với một flow entry, thành phần counter của flow entry sẽ được cập nhật. Nếu thủ tục tìm kiếm flow entry trong bảng flow không trả về một kết quả, tức là không tìm thấy flow entry nào, thì hành động được thực hiện bởi switch sẽ phụ thuộc vào action được định nghĩa tại **table-miss flow entry**. Bảng flow phải chứa một table-miss flow entry để xử lý packet trong trường hợp không tìm thấy flow entry. Entry đặc biệt này xác định một tập các action sẽ được thực hiện khi không tìm thấy entry phù hợp nào với một packet đến. Các hành động bao gồm xóa gói tin, gửi gói tin ra tất cả các interface, hoặc forward packet đến controller trong qua OpenFlow channel. Các trường header được sử dụng cho việc tìm kiếm trong bảng phụ thuộc vào các kiểu packet như mô tả dưới đây:
- Quy tắc xác định port (ingress port) được kết hợp với port vật lý mà gói tin đi vào.
- Ethernet header (Source MAC, destination MAC, Ethernet type,...) như được thể hiện trong hình trên, được sử dụng cho tất cả packet.
- Nếu packet là một VLAN (Ethernet type là 0x8100), thì VLAN ID và VLAN PCP được sử dụng trong việc tìm kiếm flow entry.
- Đối với gói tin IP (Ethernet type là 0x0800),các trường sử dụng cho việc tìm kiếm cũng bao gồm các thành phần trong IP header (Source IP, Desitnation IP, IP protocol, ToS,...)
- Đối với các gói tin IP là TCP hay UDP (có IP protocol là 6 hoặc 17), việc tìm kiếm sẽ bao gồm các port của tầng transport (TCP/ UDP source/ Destination port).
- Đối với các gói tin IP là ICMP (có IP protocol là 1), tìm kiếm sẽ bao gồm trường type và code.
- For IP packets with nonzero fragment offset or more fragments bit set, the transport ports are set to zero for the lookup.
- Đối với các gói tin ARP (Ethernet type là 0x0806), các trường tìm kiếm có thể cũng bao gồm source IP và destination IP.

Các gói tin được kết hợp với các flow entry dựa trên dựa trên độ ưu tiên. Một entry mà xác định duy nhất (tức là không chứa * hay wildcard) thì sẽ có độ ưu tiên cao nhất. Tất cả entry chứa wildcard các một độ ưu tiên được liên kết với chúng. Một entry có độ ưu tiên cao hơn phải được tìm kiếm trước entry có độ ưu tiên thấp hơn. Nếu nhiều entry có chung độ ưu tiên, switch sẽ chọn ngẫu nhiên một entry. Hình sau sẽ thể hiện các bước xử lý một packet trong OpenFlow switch. Một chú ý quan trọng là nếu một trường trong flow table có giá trị ANY (* hoặc wildcard), nó sẽ trùng khớp với tất cả các giá trị có thể trong header.

![](https://github.com/huynhducbk95/networking_document/blob/master/image/package_in_switch.png)

### OpenFlow message
Quá trình giao tiếp giữa controller và các switch sử dụng giao thức OpenFlow, nơi mà một tập các thông điệp được định nghĩa có thể được trao đổi qua lại giữa các thực thể thông qua một secure channel. secure channel là interface được sử dụng để kết nối mỗi OpenFlow switch đến một controller. **Transport Layer Security(TLS)** kết nối đến controller cố định được khởi tạo bởi switch. Cổng port TCP mặc định của controller là 6633. switch và controller xác minh qua lại bằng cách trao đổi 
